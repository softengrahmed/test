provider \"aws\" {\n  region = var.region\n}\n\nresource \"aws_vpc\" \"main\" {\n  cidr_block = \"10.0.0.0/16\"\n}\n\nresource \"aws_subnet\" \"public\" {\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = \"10.0.1.0/24\"\n  availability_zone = var.availability_zone\n}\n\nresource \"aws_subnet\" \"private\" {\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = \"10.0.2.0/24\"\n  availability_zone = var.availability_zone\n}\n\nresource \"aws_internet_gateway\" \"main\" {\n  vpc_id = aws_vpc.main.id\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.main.id\n\n  route {\n    cidr_block = \"0.0.0.0/0\"\n    gateway_id = aws_internet_gateway.main.id\n  }\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  subnet_id      = aws_subnet.public.id\n  route_table_id = aws_route_table.public.id\n}\n\nresource \"aws_security_group\" \"web_sg\" {\n  vpc_id = aws_vpc.main.id\n\n  ingress {\n    from_port   = 80\n    to_port     = 80\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_instance\" \"web\" {\n  ami           = var.ami\n  instance_type = var.instance_type\n  subnet_id     = aws_subnet.public.id\n  security_groups = [aws_security_group.web_sg.name]\n\n  tags = {\n    Name = \"WebServer\"\n  }\n}\n\nresource \"aws_db_instance\" \"db\" {\n  allocated_storage    = 20\n  engine               = \"mysql\"\n  engine_version       = \"5.7\"\n  instance_class       = \"db.t2.micro\"\n  name                 = \"mydb\"\n  username             = var.db_username\n  password             = var.db_password\n  parameter_group_name = \"default.mysql5.7\"\n  skip_final_snapshot  = true\n  vpc_security_group_ids = [aws_security_group.web_sg.id]\n  db_subnet_group_name = aws_db_subnet_group.main.name\n}\n\nresource \"aws_db_subnet_group\" \"main\" {\n  name       = \"main\"\n  subnet_ids = [aws_subnet.private.id]\n\n  tags = {\n    Name = \"MainDBSubnetGroup\"\n  }\n}\n\nresource \"aws_elb\" \"main\" {\n  name               = \"main-elb\"\n  availability_zones = [var.availability_zone]\n\n  listener {\n    instance_port     = 80\n    instance_protocol = \"HTTP\"\n    lb_port           = 80\n    lb_protocol       = \"HTTP\"\n  }\n\n  health_check {\n    target              = \"HTTP:80/\"\n    interval            = 30\n    timeout             = 5\n    healthy_threshold   = 2\n    unhealthy_threshold = 2\n  }\n\n  instances = [aws_instance.web.id]\n\n  tags = {\n    Name = \"MainELB\"\n  }\n}\n